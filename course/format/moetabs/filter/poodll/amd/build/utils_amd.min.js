define(["jquery","core/log"],function(a,b){"use strict";return b.debug("Filter PoodLL: utils initialising"),{whiteboards:[],whiteboardopts:[],timeouthandles:[],WhiteboardUploadHandler:function(a){var b=this.getbyid(a+"_btn_upload_whiteboard");b.disabled=!0,clearTimeout(this.timeouthandle),this.CallFileUpload(a)},CallFileUpload:function(a){var b=this.whiteboards[a],c=null,d="";if(0==a.indexOf("drawingboard_")){c=b.canvas;var d=JSON.stringify(b.history,null,2)}else{c=this.whiteboardopts[a].bgimage?b.canvasWithBackground(this.getbyid(a+"_separate-background-image")):b.getImage({});var d=JSON.stringify(b.getSnapshot())}if(this.whiteboardopts[a].vectorcontrol){var e=this.getbyid(this.whiteboardopts[a].vectorcontrol);e&&(e.value=d)}var f=c.toDataURL().split(",")[1],g={type:"image/png"};this.UploadFile(g,f,a)},loadmobileupload:function(a,b){this.gyui=a,this.whiteboardopts[b.recorderid]=b;var c=this.getbyid(b.recorderid+"_poodllfileselect");if(c){var d=this;c.addEventListener("change",function(a){return function(b){d.FileSelectHandler(b,a)}}(b),!1)}},FileSelectHandler:function(a,b){for(var c,d=a.target.files||a.dataTransfer.files,e=0;c=d[e];e++)this.ParseFile(c,b)},ParseFile:function(a,b){var c="",d=new FileReader,e=this;d.onloadend=function(d){c=d.target.result,e.UploadFile(a,c,b.recorderid)},d.readAsDataURL(a)},Output:function(a,b){var c=this.getbyid(a+"_messages");c.innerHTML=b},getbyid:function(b){b="#"+b.replace(/(:|\.|\[|\]|,)/g,"\\$1");var c=a(b);return c&&c.length>0?c[0]:(c=a(b,window.parent.document),c&&c.length>0?c[0]:null)},UploadFile:function(a,b,c){var d=this.whiteboardopts[c],e=new XMLHttpRequest,f="";switch(a.type){case"image/jpeg":f="jpg";break;case"image/png":f="png";break;case"video/quicktime":f="mov";break;case"audio/mpeg3":f="mp3";break;case"audio/x-mpeg-3":f="mp3";break;case"audio/mpeg3":f="mp3";break;case"audio/3gpp":f="3gpp";break;case"video/mpeg3":f="3gpp";break;case"video/mp4":f="mp4"}var g=this.getbyid(c+"_progress");if(null!=g){var h=g.firstChild;null==h&&(h=g.appendChild(document.createElement("p"))),h.className="",h.style.display="block",h.style.backgroundPosition="100% 0",e.upload.addEventListener("progress",function(a){var b=parseInt(100-a.loaded/a.total*100);h.style.backgroundPosition=b+"% 0"},!1)}else var h=!1;this.Output(c,"Uploading."),e.onreadystatechange=function(a){return function(b){if(4==e.readyState)if(h&&(h.className=200==e.status?"success":"failure"),200==e.status){var f=e.responseText,g=f.indexOf("success<error>");if(1>g)return;var i=f.indexOf("</error>"),j=f.substring(g+14,i);if(d.callbackjs&&""!=d.callbackjs){var k=new Array;k[0]=d.recorderid,k[1]="filesubmitted",k[2]=j,k[3]=d.updatecontrol,a.Output(c,"File saved successfully."),a.executeFunctionByName(d.callbackjs,window,k)}else{a.Output(c,"File saved successfully.");var l=c+"_updatecontrol",m=a.getbyid(l);if(!m)return void a.Output(c,"could not fetch by id: "+l);m=m.value;var n=a.getbyid(m);n?n.value=j:a.Output(c,"File could not be uploaded.")}}else a.Output(c,"File could not be uploaded.")}}(this);var i="datatype=uploadfile";i+="&paramone="+encodeURIComponent(b),i+="&paramtwo="+f,i+="&paramthree="+this.getbyid(c+"_mediatype").value,i+="&requestid="+c,i+="&contextid="+this.getbyid(c+"_contextid").value,i+="&component="+this.getbyid(c+"_component").value,i+="&filearea="+this.getbyid(c+"_filearea").value,i+="&itemid="+this.getbyid(c+"_itemid").value,e.open("POST",this.getbyid(c+"_fileliburl").value,!0),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.setRequestHeader("Cache-Control","no-cache"),e.setRequestHeader("Content-length",i.length),e.setRequestHeader("Connection","close"),e.send(i)},executeFunctionByName:function(a,b,c){for(var d=a.split("."),e=d.pop(),f=0;f<d.length;f++)b=b[d[f]];return b[e].call(this,c)}}});