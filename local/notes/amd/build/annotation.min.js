define(["jquery","local_notes/annotator","core/ajax","local_notes/autosize"],function(a,b,c,d){var e,f,g,h={merkannotaion:function(c,h){function i(){return{annotationEditorShown:function(a){return'<img src="'+a.userpicture+'" />'}}}var j=new b.App;j.include(b.ui.main,{element:document.querySelector("#note")}),j.include(b.identity.simple),j.include(b.authz.acl),j.include(i),j.include(this.moodlestorage),j.start().then(function(){var a=j.annotations.store.query(c.noteid);e=c.noteid,f=h,g=c,a.then(function(a){if(c.admin)for(var b in a.rows)a.rows[b].permissions.update.push(c.userid),a.rows[b].permissions["delete"].push(c.userid);j.ident.identity=c.userid,j.annotations.runHook("annotationsLoaded",[a.rows])})}),d(a("div.annotator-outer.annotator-editor textarea"))},moodlestorage:function(d){var h=function(){};("undefined"==typeof d||null===d)&&(d={}),d.onError=d.onError||function(a){h(a,"error")};var i={create:function(a){a.noteid=e;var c=this.ajaxcall("create",a);return c.then(function(a){var c=new b.ui.highlighter.Highlighter(document.querySelector("#note"));c.drawnewannotation(a),g.noteid=e,f.insert_new_notes_version(g)}),c},query:function(a){return this.search(a)},search:function(a){return this.ajaxcall("search",{noteid:a})},"delete":function(b){a("[data-annotation-id="+b.id+"]").contents().unwrap();var c=this.ajaxcall("delete",{id:b.id});return c.then(function(){f.insert_new_notes_version(g)}),c},update:function(a){a.permissions["delete"]=[a.permissions["delete"][0]];var b=this.ajaxcall("update",a);return b},resolved:function(b){this.ajaxcall("resolved",{id:b.id}),a("[data-annotation-id="+b.id+"]").removeClass("annotator-hl").addClass("annotator-hl-resolved"),f.insert_new_notes_version(g)},ajaxcall:function(a,b){var d={};return d.methodname="notes_"+a,d.args=b,c.call([d])[0]}};return{configure:function(a){a.registerUtility(i,"storage")},start:function(a){h=a.notify}}}};return h});