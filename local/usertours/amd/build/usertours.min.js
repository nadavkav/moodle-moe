define(["core/ajax","local_usertours/bootstrap-tour","jquery","core/templates","core/str"],function(a,b,c,d,e){var f={tourId:null,tourList:null,currentTour:null,context:null,init:function(a,b,d){f.context=d,Array.isArray(a)?f.showTourList(a,d):(f.tourId=a,"undefined"==typeof b&&(b=!0),b&&f.fetchTour(a),f.addResetLink(),c("body").on("click",'[data-action="local_usertours/resetpagetour"]',function(a){a.preventDefault(),f.resetTourState(f.tourId)}))},fetchTour:function(b){c.when(a.call([{methodname:"local_usertours_fetch_tour",args:{tourid:b,context:f.context}}])[0],d.render("local_usertours/tourstep",{})).then(function(a,c){f.startBootstrapTour(b,c[0],a.tourConfig)})},addResetLink:function(){e.get_string("resettouronpage","local_usertours").done(function(a){c("footer, .logininfo").last().append('<div class="usertour"><a href="#" data-action="local_usertours/resetpagetour">'+a+"</a></div>")})},startBootstrapTour:function(a,d,e){f.currentTour&&(e.onEnd=null,f.currentTour.end()),e.onEnd=f.markTourComplete,e.template=d,f.currentTour=new b(e),f.currentTour.init(!0),f.currentTour.start(!0),c(".select-tour").length&&c(".btn-group").css("visibility","hidden"),c(".select-tour").click(function(){setTimeout(function(){c(".btn-group").removeAttr("style")},500)})},markTourComplete:function(){a.call([{methodname:"local_usertours_complete_tour",args:{tourid:f.tourId,currentpage:window.location.href}}])},resetTourState:function(b){a.call([{methodname:"local_usertours_reset_tour",args:{path:window.location.href,tourid:b}}]),location.reload()},showTourList:function(b,e){f.tourList=b,c.when(a.call([{methodname:"local_usertours_fetch_tours_for_list",args:{tours:b,context:e}}])[0],d.render("local_usertours/tourstep",{})).then(function(a,b){if(0!==a.tours.length){for(var d="",g=0;g<a.tours.length;g++)d=d+'<div class="select-tour" id="tour_'+a.tours[g].tourid+'">'+a.tours[g].title+"</div>";f.startBootstrapTour(0,b[0],{name:"local_usertours_choice",steps:new Array({backdrop:!1,content:d,element:"",orphan:!0,placement:"top",reflex:!1,title:M.util.get_string("tourchois","local_usertours")})}),c(".select-tour").click(function(){var a=c(this).attr("id");a=a.split("_"),f.init(a[1],!0,e)})}}),c("body").on("click",'[data-action="local_usertours/resetpagetour"]',function(a){a.preventDefault();for(var c=0;c<b.length;c++)f.resetTourState(b[c])})}};return{init:f.init,resetTourState:f.resetTourState}});