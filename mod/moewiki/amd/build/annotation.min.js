define(["jquery","mod_moewiki/annotator","core/ajax","mod_moewiki/autosize"],function(a,b,c,d){var e,f,g,h,i,j={merkannotaion:function(c){function j(){return{beforeAnnotationCreated:function(a){a.page=c.wikiid,a.userpage=c.userpage},annotationEditorShown:function(a){return'<img src="'+a.userpicture+'" />'}}}var k=new b.App;k.include(b.ui.main,{element:document.querySelector(".moewiki_content")}),k.include(b.identity.simple),k.include(b.authz.acl),k.include(j),k.include(this.moodlestorage),k.start().then(function(){var a=k.annotations.store.query(c.wikiid);e=c.wikiid,f=c.pagename,g=c.userpage,h=c.groupid,i=c.id,a.then(function(a){if(c.admin)for(var b in a.rows)a.rows[b].permissions.update.push(c.userid),a.rows[b].permissions["delete"].push(c.userid);k.ident.identity=c.userid,k.annotations.runHook("annotationsLoaded",[a.rows])})}),d(a("div.annotator-outer.annotator-editor textarea"))},moodlestorage:function(d){function j(){var b={text:a(".moewiki_content").html(),wikiid:e,pagename:f,userid:g,groupid:h,id:i};c.call([{methodname:"moe_wiki_create_ver",args:b}])}var k=function(){};"undefined"!=typeof d&&null!==d||(d={}),d.onError=d.onError||function(a){k(a,"error")};var l={create:function(a){var c=this.ajaxcall("create",a);return c.then(function(a){var c=new b.ui.highlighter.Highlighter(document.querySelector(".moewiki_content"));c.drawnewannotation(a),j()}),c},query:function(a){return this.search(a)},search:function(a){return this.ajaxcall("search",{wikiid:a})},"delete":function(b){a("[data-annotation-id="+b.id+"]").contents().unwrap();var c=this.ajaxcall("delete",{id:b.id});return c.then(function(){j()}),c},update:function(a){a.permissions["delete"]=[a.permissions["delete"][0]];var b=this.ajaxcall("update",a);return b},resolved:function(b){this.ajaxcall("resolved",{id:b.id}),a("[data-annotation-id="+b.id+"]").removeClass("annotator-hl").addClass("annotator-hl-resolved"),j()},ajaxcall:function(a,b){var d={};return d.methodname="moe_wiki_"+a,d.args=b,c.call([d])[0]}};return{configure:function(a){a.registerUtility(l,"storage")},start:function(a){k=a.notify}}}};return j});