define(["jquery","mod_moewiki/annotator","core/ajax","mod_moewiki/autosize"],function(a,b,c,d){var e={merkannotaion:function(c){function e(){return{beforeAnnotationCreated:function(a){a.page=c.wikiid,a.userpage=c.userpage},annotationEditorShown:function(a){return'<img src="'+a.userpicture+'" />'}}}var f=new b.App;f.include(b.ui.main,{element:document.querySelector(".moewiki_content")}),f.include(b.identity.simple),f.include(b.authz.acl),f.include(e),f.include(this.moodlestorage),f.start().then(function(){var a=f.annotations.store.query(c.wikiid,c.userpage);a.then(function(a){if(c.admin)for(var b in a.rows)a.rows[b].permissions.update.push(c.userid),a.rows[b].permissions["delete"].push(c.userid);f.ident.identity=c.userid,f.annotations.runHook("annotationsLoaded",[a.rows])})}),d(a("div.annotator-outer.annotator-editor textarea"))},moodlestorage:function(a){var b=function(){};("undefined"==typeof a||null===a)&&(a={}),a.onError=a.onError||function(a){b(a,"error")};var d={create:function(a){return("undefined"==typeof a||null===a)&&(a={}),this.ajaxcall("create",a)},query:function(a,b){return this.search(a,b)},search:function(a,b){return this.ajaxcall("search",{wikiid:a,userpage:b})},"delete":function(a){return this.ajaxcall("delete",{id:a.id})},update:function(a){return a.permissions["delete"]=[a.permissions["delete"][0]],this.ajaxcall("update",a)},resolved:function(a){this.ajaxcall("resolved",{id:a.id})},ajaxcall:function(a,b){var d={};return d.methodname="moe_wiki_"+a,d.args=b,c.call([d])[0]}};return{configure:function(a){a.registerUtility(d,"storage")},start:function(a){b=a.notify}}}};return e});