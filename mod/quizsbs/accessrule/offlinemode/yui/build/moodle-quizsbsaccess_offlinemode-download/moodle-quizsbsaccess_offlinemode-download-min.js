YUI.add("moodle-quizsbsaccess_offlinemode-download",function(e,t){M.quizsbsaccess_offlinemode=M.quizsbsaccess_offlinemode||{},M.quizsbsaccess_offlinemode.download={SELECTORS:{DOWNLOAD_CONFIRM_MESSAGE:"#quizsbs-download-confirm-message",quizsbs_FORM:"#responseform"},filename:null,publicKey:null,form:null,init:function(t,n){this.filename=t,this.publicKey=n,e.Crypto.sjcl.random.startCollectors(),e.Crypto.sjcl.beware["CBC mode is dangerous because it doesn't protect message integrity."](),this.form=e.one(this.SELECTORS.quizsbs_FORM);if(!this.form)return;e.delegate("click",this.downloadClicked,"body",".response-download-link",this)},downloadClicked:function(t){var n=t.currentTarget;typeof tinyMCE!="undefined"&&tinyMCE.triggerSave(),n.set("download",this.filename.replace(/-d\d+\.attemptdata/,"-d"+this.getCurrentDatestamp()+".attemptdata"));var r={responses:e.IO.stringify(this.form)};this.publicKey&&(r=this.encryptResponses(r)),n.set("href","data:application/octet-stream,"+e.JSON.stringify(r)),e.later(500,this,this.showDownloadMessage,n.ancestor("p").ancestor())},getCurrentDatestamp:function(){function t(e){return e<10?"0"+e:e}var e=new Date;return""+e.getUTCFullYear()+t(e.getUTCMonth()+1)+t(e.getUTCDate())+t(e.getUTCHours())+t(e.getUTCMinutes())},showDownloadMessage:function(t){function n(e){return e<10?"0"+e:e}e.one(this.SELECTORS.DOWNLOAD_CONFIRM_MESSAGE)&&e.one(this.SELECTORS.DOWNLOAD_CONFIRM_MESSAGE).remove(!0),now=new Date,t.append('<p id="quizsbs-download-confirm-message">'+M.util.get_string("lastsavedtothiscomputer","quizsbsaccess_offlinemode",n(now.getHours())+":"+n(now.getMinutes()))+"</p>")},encryptResponses:function(t){var n=e.Crypto.sjcl.random.randomWords(8),r={},i=e.Crypto.sjcl.encrypt(n,t.responses,{ks:256,mode:"cbc"},r),s=new e.Crypto.JSEncrypt;return s.setPublicKey(this.publicKey),{responses:e.JSON.parse(i).ct,key:s.encrypt(e.Crypto.sjcl.codec.base64.fromBits(n)),iv:s.encrypt(e.Crypto.sjcl.codec.base64.fromBits(r.iv))}}}},"@VERSION@",{requires:["base","node","event","node-event-delegate","json","io-form","moodle-quizsbsaccess_offlinemode-jsencrypt","moodle-quizsbsaccess_offlinemode-sjcl"]});
